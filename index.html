<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shopping List</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary:#4f46e5;
  --danger:#dc2626;
  --bg:#f1f5f9;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#64748b;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:"Segoe UI",system-ui,sans-serif;
  padding:16px;
}
.container{
  max-width:520px;
  margin:auto;
  background:var(--card);
  border-radius:18px;
  padding:16px;
  box-shadow:0 20px 40px rgba(0,0,0,.1);
}
h2{text-align:center;margin:6px 0 12px}

input{
  width:100%;
  height:46px;
  border-radius:12px;
  border:1px solid var(--border);
  padding:0 14px;
}

.suggestions{
  border:1px solid var(--border);
  border-top:none;
  border-radius:0 0 12px 12px;
  max-height:160px;
  overflow:auto;
}
.suggestions div{
  padding:12px;
  cursor:pointer;
}
.suggestions div:hover{background:#eef2ff}

.item{
  display:flex;
  justify-content:space-between;
  padding:16px;
  margin-top:10px;
  border:1px solid var(--border);
  border-radius:14px;
  background:#f9fafb;
  cursor:pointer;
}
.item-name{font-weight:600}
.item-price{color:#16a34a;font-weight:700}

.basket{
  margin-top:18px;
  border-top:2px dashed var(--border);
  padding-top:14px;
}
.basket-item{
  padding:12px 0;
  border-bottom:1px solid var(--border);
}
.qty-row{
  display:flex;
  gap:8px;
  margin-top:6px;
}
.qty-row input{
  width:90px;
  height:38px;
  border-radius:10px;
  text-align:center;
}
.remove{color:var(--danger);cursor:pointer}
.custom-tag{font-size:11px;color:var(--muted)}

button{
  width:100%;
  height:46px;
  margin-top:12px;
  border:none;
  border-radius:14px;
  background:var(--primary);
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
.add-custom{background:#6b7280}

/* TOAST */
.toast{
  display:none;
  background:#eef2ff;
  color:#1e3a8a;
  padding:10px 14px;
  border-radius:10px;
  font-size:14px;
  margin-bottom:12px;
  text-align:center;
  animation:fadeSlide .25s ease;
}
@keyframes fadeSlide{
  from{opacity:0;transform:translateY(-6px)}
  to{opacity:1;transform:translateY(0)}
}
</style>
</head>

<body>

<div class="container">
  <h2>üõí Shopping List</h2>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <!-- STORE -->
  <input id="dealerInput" placeholder="Select store‚Ä¶" oninput="filterDealers()">
  <div id="dealerSug" class="suggestions"></div>

  <!-- ITEMS -->
  <div id="items"></div>

  <!-- CUSTOM -->
  <button class="add-custom" onclick="addCustomItem()">‚ûï Not in the list?</button>

  <!-- BASKET -->
  <div id="basket" class="basket" style="display:none">
    <h3>Your List</h3>
    <div id="basketItems"></div>
    <button onclick="sendToGoogleTasks()">Add to Google To-Do</button>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzRt_ad2rXgZNVO4_Nlumm8EAxN7jcG7gG1y0yKEec7WXnws68ygcAqrhCjRzcmdWzl/exec";
const API_KEY="9848o22338B!";
const TASK_API_URL="https://script.google.com/macros/s/AKfycbz0d_gOUxq6w7geJvlt9R1hUaR8aLItOBsI1p3Cd6UCS2p1lCGvaAzVWG7rVK2tMJnE7Q/exec";

let groceries={}, dealers=[], cart={};
const basketBox=document.getElementById("basket");

/* ---------- LOAD DATA ---------- */
fetch(`${API_URL}?key=${API_KEY}`)
  .then(r=>r.json())
  .then(d=>{groceries=d||{};initDealers();});

/* ---------- DEALERS ---------- */
function initDealers(){
  const s=new Set();
  Object.values(groceries).forEach(a=>a.forEach(d=>s.add(d.dealer)));
  dealers=[...s];
}

function filterDealers(){
  dealerSug.innerHTML="";
  const v=dealerInput.value.toLowerCase();
  if(!v) return;
  dealers.filter(d=>d.toLowerCase().includes(v)).forEach(d=>{
    const div=document.createElement("div");
    div.textContent=d;
    div.onclick=()=>selectDealer(d);
    dealerSug.appendChild(div);
  });
}

function selectDealer(dealer){
  dealerInput.value=dealer;
  dealerSug.innerHTML="";
  cart={};
  renderBasket();
  showItems(dealer);
}

/* ---------- TOAST ---------- */
function showToast(msg){
  const toast=document.getElementById("toast");
  toast.textContent=msg;
  toast.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>toast.style.display="none",2000);
}

/* ---------- ITEMS ---------- */
function showItems(dealer){
  items.innerHTML="";
  const list=[];
  Object.keys(groceries).forEach(item=>{
    groceries[item].forEach(d=>{
      if(d.dealer===dealer) list.push({name:item,price:d.price});
    });
  });
  list.sort((a,b)=>a.name.localeCompare(b.name));
  list.forEach(o=>{
    items.innerHTML+=`
      <div class="item" onclick="addItem('${o.name}',${o.price})">
        <div class="item-name">${o.name}</div>
        <div class="item-price">‚Çπ${o.price}</div>
      </div>`;
  });
}

/* ---------- ADD ITEM ---------- */
function addItem(item,price){
  const key=item.toLowerCase();
  const existing=Object.keys(cart).find(k=>k.toLowerCase()===key);
  if(existing){
    cart[existing].qty+=1;
    showToast(`"${existing}" already exists, quantity updated`);
  }else{
    cart[item]={qty:1,price,custom:false};
    showToast(`"${item}" added to list`);
  }
  renderBasket();
}

/* ---------- CUSTOM ITEM ---------- */
function addCustomItem(){
  const name=prompt("Enter item name");
  if(!name) return;
  const key=name.toLowerCase();
  const existing=Object.keys(cart).find(k=>k.toLowerCase()===key);
  if(existing){
    cart[existing].qty+=1;
    showToast(`"${existing}" already exists, quantity updated`);
  }else{
    cart[name]={qty:1,custom:true};
    showToast(`"${name}" added to list`);
  }
  renderBasket();
}

/* ---------- BASKET ---------- */
function updateQty(item,val){
  const q=parseFloat(val);
  if(!q||q<=0) delete cart[item];
  else cart[item].qty=parseFloat(q.toFixed(2));
  renderBasket();
}

function renderBasket(){
  basketItems.innerHTML="";
  Object.keys(cart).sort().forEach(item=>{
    const b=cart[item];
    basketItems.innerHTML+=`
      <div class="basket-item">
        <strong>${item}</strong>
        ${b.custom?'<span class="custom-tag">(Custom)</span>':''}
        ${b.price?`<br>‚Çπ${b.price} per unit`:''}
        <div class="qty-row">
          <input type="number" step="0.01" value="${b.qty}"
            onchange="updateQty('${item}',this.value)">
          <span class="remove" onclick="updateQty('${item}',0)">Remove</span>
        </div>
      </div>`;
  });
  basketBox.style.display=Object.keys(cart).length?"block":"none";
}

/* ---------- SEND ---------- */
function sendToGoogleTasks(){
  const items=Object.keys(cart).map(i=>({name:i,qty:cart[i].qty}));
  fetch(TASK_API_URL,{
    method:"POST",
    body:JSON.stringify({listName:"Shopping List",items})
  })
  .then(()=>alert("Added to Google To-Do & Telegram notified üîî"))
  .catch(()=>alert("Failed ‚ùå"));
}
</script>

</body>
</html>
